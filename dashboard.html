<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker - Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="assets/logo.svg" alt="ExpenseTracker" class="sidebar-logo" />
        <div class="sidebar-title-wrap">
          <h2>ExpenseTracker</h2>
          <p>Track your finances</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <li class="sidebar-nav-item">
          <a href="#dashboard" class="sidebar-nav-link icon-dashboard" title="Dashboard"><span class="nav-label">Dashboard</span></a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#accounts" class="sidebar-nav-link icon-accounts" title="Accounts"><span class="nav-label">Accounts</span></a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#transactions" class="sidebar-nav-link icon-transactions" title="Transactions"><span class="nav-label">Transactions</span></a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#spending-breakdown" class="sidebar-nav-link icon-breakdown" title="Spending"><span class="nav-label">Spending</span></a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#analytics" class="sidebar-nav-link icon-analytics" title="Analytics"><span class="nav-label">Analytics</span></a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#insights" class="sidebar-nav-link icon-insights" title="Insights"><span class="nav-label">Insights</span></a>
        </li>
      </nav>

      <div class="sidebar-footer">
        <!-- Empty - user controls now in top-right -->
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="top-bar-left">
          <button type="button" id="menuToggle" class="menu-toggle">‚ò∞</button>
          <h1>Dashboard</h1>
          <p class="user-greeting" id="userGreeting">Welcome!</p>
        </div>
        <div class="top-bar-controls">
          <!-- User Profile Dropdown -->
          <div class="user-profile-dropdown">
            <button type="button" class="user-profile-btn" id="userProfileBtn" aria-haspopup="true" aria-expanded="false" onclick="toggleUserDropdown()">
              <img id="userProfilePhoto" src="" alt="Profile" class="user-photo" />
              <span class="user-initials" id="userInitials" aria-hidden="true">U</span>
              <span id="userProfileName" class="user-name">User</span>
            </button>
            <div class="user-dropdown-menu" id="userDropdownMenu" role="menu" aria-hidden="true">
              <div class="dropdown-header">
                <img id="dropdownPhoto" src="" alt="Profile" class="dropdown-photo">
                <div class="dropdown-user-info">
                  <div id="dropdownName" class="dropdown-name">User</div>
                  <div id="dropdownEmail" class="dropdown-email">you@example.com</div>
                </div>
              </div>
              <div class="dropdown-actions">
                <button type="button" class="dropdown-item" id="settingsBtn" onclick="window.location.href='settings.html'">‚öôÔ∏è Account Settings</button>
                <button type="button" class="dropdown-item" id="toggleDarkBtn" onclick="toggleDarkMode()">üåì Toggle Theme</button>
                <button type="button" class="dropdown-item" id="reportsToggleBtn" aria-expanded="false" onclick="toggleReportsMenu()">üì• Quick Reports</button>
                <div class="reports-submenu" id="reportsSubmenu" aria-hidden="true">
                  <button class="btn btn-small btn-icon" onclick="exportPNG()">Export PNG</button>
                </div>
                <div class="dropdown-separator"></div>
                <button type="button" class="dropdown-item logout" id="logoutBtn" onclick="logout()">üö™ Logout</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <!-- Summary Cards Section -->
        <section id="dashboard" class="section">
          <h2 class="section-title">Financial Summary</h2>
          
          <div class="summary-grid">
            <div class="summary-card">
              <h3>Total Balance</h3>
              <div class="amount" id="totalBalanceAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Total Income</h3>
              <div class="amount" id="totalCreditAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Total Expenses</h3>
              <div class="amount" id="totalDebitAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Net Savings</h3>
              <div class="amount" id="netSavingsAmount">‚Çπ0.00</div>
            </div>
          </div>
        </section>

        <!-- Bank Accounts Section -->
        <section id="accounts" class="section">
          <h2 class="section-title">Bank Accounts</h2>

          <!-- Add Account Form -->
          <div class="add-account-form-wrapper">
            <h3 class="add-account-title">Add New Account</h3>
            <form id="addAccountForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="bankName">Bank Name</label>
                  <input type="text" id="bankName" placeholder="Enter bank name" required>
                </div>
                <div class="form-group">
                  <label for="accountType">Account Type</label>
                  <select id="accountType" required>
                    <option value="Savings">Savings</option>
                    <option value="Current">Current</option>
                    <option value="Credit Card">Credit Card</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="initialBalance">Initial Balance</label>
                  <input type="number" id="initialBalance" step="0.01" placeholder="0.00" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-add-account">Add Account</button>
            </form>
          </div>

          <!-- Accounts Display -->
          <div class="accounts-grid" id="accountsList">
            <p class="no-data">No accounts added yet. Add one to get started!</p>
          </div>
        </section>

        <!-- Add Transaction Section -->
        <section id="transactions" class="section">
          <h2 class="section-title">Transactions</h2>

          <!-- Add Transaction Form -->
          <div class="add-transaction-form-wrapper">
            <h3 class="add-transaction-title">Add New Transaction</h3>
            <form id="addTransactionForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="transactionAccount">Select Account</label>
                  <select id="transactionAccount" required>
                    <option value="0">Select Account</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionType">Type</label>
                  <select id="transactionType" required>
                    <option value="debit">Expense (Debit)</option>
                    <option value="credit">Income (Credit)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionCategory">Category</label>
                  <select id="transactionCategory" required>
                    <option value="">Select Category</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionPaymentMethod">Payment Method</label>
                  <select id="transactionPaymentMethod" required>
                    <option value="">Select Payment Method</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionAmount">Amount</label>
                  <input type="number" id="transactionAmount" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                  <label for="transactionDate">Date</label>
                  <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group form-group-full">
                  <label for="transactionNotes">Notes (Optional)</label>
                  <textarea id="transactionNotes" placeholder="Add notes about this transaction" rows="3"></textarea>
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-add-transaction">Add Transaction</button>
            </form>
          </div>
            </form>
          </div>

          <!-- Recent Transactions -->
          <div class="recent-transactions-wrapper">
            <h3 class="recent-transactions-title">Recent Transactions</h3>
            <div class="transactions-list" id="recentTransactions">
              <p class="no-data">No transactions yet. Add one to get started!</p>
            </div>
          </div>
        </section>

        <!-- Spending Breakdown Section -->
        <section id="spending-breakdown" class="section">
          <h2 class="section-title">Spending Breakdown</h2>

          <!-- Breakdown Charts Grid -->
          <div class="charts-grid">
            <div class="chart-container">
              <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-color);">Spending by Category</h3>
              <canvas id="spendingByCategoryChart"></canvas>
            </div>
            <div class="chart-container">
              <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-color);">Spending by Payment Method</h3>
              <canvas id="spendingByMethodChart"></canvas>
            </div>
          </div>

          <!-- Detailed Category & Payment Method Breakdown -->
          <div style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--text-color);">Detailed Breakdown (Category + Payment Method)</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; background-color: var(--light-bg); border-radius: 0.5rem;">
                <thead>
                  <tr style="background-color: rgba(37, 99, 235, 0.1); border-bottom: 2px solid var(--primary-color);">
                    <th style="padding: 0.75rem; text-align: left; color: var(--text-color); font-weight: 600;">Category</th>
                    <th style="padding: 0.75rem; text-align: left; color: var(--text-color); font-weight: 600;">Payment Method</th>
                    <th style="padding: 0.75rem; text-align: right; color: var(--text-color); font-weight: 600;">Amount</th>
                    <th style="padding: 0.75rem; text-align: center; color: var(--text-color); font-weight: 600;">Transactions</th>
                  </tr>
                </thead>
                <tbody id="spendingBreakdownTable">
                  <tr>
                    <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-light);">No data available. Add transactions to see breakdown.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
          <h2 class="section-title">Analytics & Insights</h2>

          <!-- Charts Grid -->
          <div class="charts-grid">
            <div class="chart-container">
              <canvas id="monthlySpendingChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="spendingTrendChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="categoryWiseChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="creditVsDebitChart"></canvas>
            </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
              <canvas id="quarterlySpendingChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Financial Insights Section -->
        <section id="insights" class="section">
          <h2 class="section-title">Financial Insights & Recommendations</h2>
          
          <div class="insights-grid" id="financialInsights">
            <p class="no-data">Add transactions to see personalized insights.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/storage.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Initialize page on load
    window.addEventListener('load', function() {
      loadUserProfile();
      applyDarkModePreference();
    });

    // Set today's date as default in transaction form
    const dateInput = document.getElementById('transactionDate');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      dateInput.max = today;
    }

    // Account Settings Functions
    function loadUserProfile() {
      const user = JSON.parse(localStorage.getItem('currentUser')) || {};
      const userPhoto = localStorage.getItem('userProfilePhoto') || '';
      
      // Update top-right user profile button (show username or name)
      const userNameEl = document.getElementById('userProfileName');
      const userPhotoEl = document.getElementById('userProfilePhoto');
      
      if (userNameEl) {
        userNameEl.textContent = user.username || user.name || user.email || 'User';
      }

      // Populate dropdown header info
      const dropdownName = document.getElementById('dropdownName');
      const dropdownEmail = document.getElementById('dropdownEmail');
      const dropdownPhoto = document.getElementById('dropdownPhoto');

      if (dropdownName) dropdownName.textContent = user.name || user.username || user.email || 'User';
      if (dropdownEmail) dropdownEmail.textContent = user.email || '';

      if (userPhotoEl) {
        if (userPhoto) {
          userPhotoEl.src = userPhoto;
          userPhotoEl.style.display = 'block';
        } else {
          userPhotoEl.style.display = 'none';
        }
      }

      // Initials fallback
      const userInitialsEl = document.getElementById('userInitials');
      const nameForInitials = user.name || user.username || user.email || 'U';
      const initials = nameForInitials.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase();
      if (userInitialsEl) {
        userInitialsEl.textContent = initials;
        if (userPhoto) {
          userInitialsEl.style.display = 'none';
        } else {
          userInitialsEl.style.display = 'inline-flex';
        }
      }

      if (dropdownPhoto) {
        if (userPhoto) {
          dropdownPhoto.src = userPhoto;
          dropdownPhoto.style.display = 'block';
        } else {
          dropdownPhoto.style.display = 'none';
        }
      }
    }

// Toggle User Dropdown Menu
    function toggleUserDropdown() {
      const menu = document.getElementById('userDropdownMenu');
      if (menu) {
        const isActive = menu.classList.toggle('active');
        // accessibility attributes
        document.getElementById('userProfileBtn').setAttribute('aria-expanded', isActive);
        menu.setAttribute('aria-hidden', !isActive);
      }
    }

    // Toggle Reports Menu
    function toggleReportsMenu() {
      const reportsSubmenu = document.getElementById('reportsSubmenu');
      const reportsToggleBtn = document.getElementById('reportsToggleBtn');
      if (reportsSubmenu) {
        const isActive = reportsSubmenu.classList.toggle('active');
        reportsToggleBtn.setAttribute('aria-expanded', isActive);
        reportsSubmenu.setAttribute('aria-hidden', !isActive);
      }
    }

    // Toggle Dark Mode
    function toggleDarkMode() {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const userProfile = document.querySelector('.user-profile-dropdown');
      if (userProfile && !userProfile.contains(e.target)) {
        const menu = document.getElementById('userDropdownMenu');
        if (menu) {
          menu.classList.remove('active');
        }
      }
    });

    // Export PNG of dashboard content
    function exportPNG() {
      const el = document.querySelector('.dashboard-content');
      if (!el) return alert('Nothing to export');
      html2canvas(el, {scale:2}).then(canvas => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `expense-report-${new Date().toISOString().slice(0,10)}.png`;
        link.click();
      }).catch(err => alert('Export failed'));
    }

    // Export to PDF
    // PDF export removed
  </script>
</body>
</html>
