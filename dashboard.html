<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker - Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Expense Tracker</h2>
        <p>Track your finances</p>
      </div>

      <nav class="sidebar-nav">
        <li class="sidebar-nav-item">
          <a href="#dashboard" class="sidebar-nav-link icon-dashboard" title="Dashboard">Dashboard</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#accounts" class="sidebar-nav-link icon-accounts" title="Accounts">Accounts</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#transactions" class="sidebar-nav-link icon-transactions" title="Transactions">Transactions</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#spending-breakdown" class="sidebar-nav-link icon-breakdown" title="Spending">Spending</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#analytics" class="sidebar-nav-link icon-analytics" title="Analytics">Analytics</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="#insights" class="sidebar-nav-link icon-insights" title="Insights">Insights</a>
        </li>
      </nav>

      <div class="sidebar-footer">
        <button type="button" id="settingsBtn" class="btn btn-primary" title="Settings">‚öôÔ∏è</button>
        <button type="button" id="logoutBtn" class="btn btn-danger" title="Logout">üö™</button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="top-bar-left">
          <h1>Dashboard</h1>
          <p class="user-greeting" id="userGreeting">Welcome!</p>
        </div>
        <div class="top-bar-controls">

          <button type="button" id="menuToggle" class="menu-toggle">‚ò∞</button>
        </div>
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <!-- Summary Cards Section -->
        <section id="dashboard" class="section">
          <h2 class="section-title">Financial Summary</h2>
          
          <div class="summary-grid">
            <div class="summary-card">
              <h3>Total Balance</h3>
              <div class="amount" id="totalBalanceAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Total Income</h3>
              <div class="amount" id="totalCreditAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Total Expenses</h3>
              <div class="amount" id="totalDebitAmount">‚Çπ0.00</div>
            </div>
            <div class="summary-card">
              <h3>Net Savings</h3>
              <div class="amount" id="netSavingsAmount">‚Çπ0.00</div>
            </div>
          </div>
        </section>

        <!-- Bank Accounts Section -->
        <section id="accounts" class="section">
          <h2 class="section-title">Bank Accounts</h2>

          <!-- Add Account Form -->
          <div style="margin-bottom: 2rem; background-color: var(--light-bg); padding: 1.5rem; border-radius: 0.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--text-color);">Add New Account</h3>
            <form id="addAccountForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="bankName">Bank Name</label>
                  <input type="text" id="bankName" placeholder="Enter bank name" required>
                </div>
                <div class="form-group">
                  <label for="accountType">Account Type</label>
                  <select id="accountType" required>
                    <option value="Savings">Savings</option>
                    <option value="Current">Current</option>
                    <option value="Credit Card">Credit Card</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="initialBalance">Initial Balance</label>
                  <input type="number" id="initialBalance" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-primary">Add Account</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Accounts Display -->
          <div class="accounts-grid" id="accountsList">
            <p class="no-data">No accounts added yet. Add one to get started!</p>
          </div>
        </section>

        <!-- Add Transaction Section -->
        <section id="transactions" class="section">
          <h2 class="section-title">Transactions</h2>

          <!-- Add Transaction Form -->
          <div style="margin-bottom: 2rem; background-color: var(--light-bg); padding: 1.5rem; border-radius: 0.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--text-color);">Add New Transaction</h3>
            <form id="addTransactionForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="transactionAccount">Select Account</label>
                  <select id="transactionAccount" required>
                    <option value="0">Select Account</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionType">Type</label>
                  <select id="transactionType" required>
                    <option value="debit">Expense (Debit)</option>
                    <option value="credit">Income (Credit)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionCategory">Category</label>
                  <select id="transactionCategory" required>
                    <option value="">Select Category</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionPaymentMethod">Payment Method</label>
                  <select id="transactionPaymentMethod" required>
                    <option value="">Select Payment Method</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="transactionAmount">Amount</label>
                  <input type="number" id="transactionAmount" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                  <label for="transactionDate">Date</label>
                  <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group form-group-full">
                  <label for="transactionNotes">Notes (Optional)</label>
                  <textarea id="transactionNotes" placeholder="Add notes about this transaction" rows="3"></textarea>
                </div>
                <div class="form-group form-group-full">
                  <button type="submit" class="btn btn-secondary">Add Transaction</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Recent Transactions -->
          <div>
            <h3 style="margin-bottom: 1rem; color: var(--text-color);">Recent Transactions</h3>
            <div class="transactions-list" id="recentTransactions">
              <p class="no-data">No transactions yet. Add one to get started!</p>
            </div>
          </div>
        </section>

        <!-- Spending Breakdown Section -->
        <section id="spending-breakdown" class="section">
          <h2 class="section-title">Spending Breakdown</h2>

          <!-- Breakdown Charts Grid -->
          <div class="charts-grid">
            <div class="chart-container">
              <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-color);">Spending by Category</h3>
              <canvas id="spendingByCategoryChart"></canvas>
            </div>
            <div class="chart-container">
              <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-color);">Spending by Payment Method</h3>
              <canvas id="spendingByMethodChart"></canvas>
            </div>
          </div>

          <!-- Detailed Category & Payment Method Breakdown -->
          <div style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--text-color);">Detailed Breakdown (Category + Payment Method)</h3>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; background-color: var(--light-bg); border-radius: 0.5rem;">
                <thead>
                  <tr style="background-color: rgba(37, 99, 235, 0.1); border-bottom: 2px solid var(--primary-color);">
                    <th style="padding: 0.75rem; text-align: left; color: var(--text-color); font-weight: 600;">Category</th>
                    <th style="padding: 0.75rem; text-align: left; color: var(--text-color); font-weight: 600;">Payment Method</th>
                    <th style="padding: 0.75rem; text-align: right; color: var(--text-color); font-weight: 600;">Amount</th>
                    <th style="padding: 0.75rem; text-align: center; color: var(--text-color); font-weight: 600;">Transactions</th>
                  </tr>
                </thead>
                <tbody id="spendingBreakdownTable">
                  <tr>
                    <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-light);">No data available. Add transactions to see breakdown.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
          <h2 class="section-title">Analytics & Insights</h2>

          <!-- Charts Grid -->
          <div class="charts-grid">
            <div class="chart-container">
              <canvas id="monthlySpendingChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="spendingTrendChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="categoryWiseChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="creditVsDebitChart"></canvas>
            </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
              <canvas id="quarterlySpendingChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Financial Insights Section -->
        <section id="insights" class="section">
          <h2 class="section-title">Financial Insights & Recommendations</h2>
          
          <div class="insights-grid" id="financialInsights">
            <p class="no-data">Add transactions to see personalized insights.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Account Settings Modal -->
  <div id="accountSettingsModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeAccountSettings()">&times;</button>
      <div class="modal-header">
        <h2>Account Settings</h2>
      </div>
      
      <form class="settings-form" id="accountSettingsForm">
        <!-- Profile Picture -->
        <div class="profile-pic-input">
          <div class="profile-pic-preview" id="profilePicPreview">üë§</div>
          <input type="file" id="profilePicFile" accept="image/*" style="display: none;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('profilePicFile').click();">
            Upload Photo
          </button>
        </div>

        <!-- User Name -->
        <div class="form-group">
          <label for="settingsUserName">Full Name</label>
          <input type="text" id="settingsUserName" placeholder="Enter your full name" required>
        </div>

        <!-- Phone Number -->
        <div class="form-group">
          <label for="settingsPhoneNumber">Phone Number</label>
          <input type="tel" id="settingsPhoneNumber" placeholder="Enter your phone number">
        </div>

        <!-- Email -->
        <div class="form-group">
          <label for="settingsEmail">Email</label>
          <input type="email" id="settingsEmail" placeholder="Enter your email" required>
        </div>

        <!-- Dark Mode Toggle -->
        <div class="form-group">
          <label for="settingsDarkMode">
            <input type="checkbox" id="settingsDarkMode" style="margin-right: 0.5rem; width: auto;">
            Dark Mode
          </label>
        </div>

        <!-- PDF Export Section -->
        <div class="pdf-export-section">
          <h3>Download Reports</h3>
          <div class="pdf-buttons">
            <button type="button" class="btn btn-primary btn-pdf-day" onclick="exportPDF('day')">Daily</button>
            <button type="button" class="btn btn-primary btn-pdf-week" onclick="exportPDF('week')">Weekly</button>
            <button type="button" class="btn btn-primary btn-pdf-month" onclick="exportPDF('month')">Monthly</button>
            <button type="button" class="btn btn-primary btn-pdf-year" onclick="exportPDF('year')">Yearly</button>
          </div>
        </div>

        <!-- Save Button -->
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
          Save Settings
        </button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/storage.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Set today's date as default in transaction form
    const dateInput = document.getElementById('transactionDate');
    if (dateInput) {
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      dateInput.max = today;
    }

    // Account Settings Functions
    function openAccountSettings() {
      const modal = document.getElementById('accountSettingsModal');
      const user = JSON.parse(localStorage.getItem('currentUser')) || {};
      document.getElementById('settingsUserName').value = user.name || '';
      document.getElementById('settingsEmail').value = user.email || '';
      document.getElementById('settingsPhoneNumber').value = user.phone || '';
      document.getElementById('settingsDarkMode').checked = localStorage.getItem('darkMode') === 'true';
      modal.classList.add('active');
    }

    function closeAccountSettings() {
      document.getElementById('accountSettingsModal').classList.remove('active');
    }

    // Save Settings
    document.getElementById('accountSettingsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const user = {
        name: document.getElementById('settingsUserName').value,
        email: document.getElementById('settingsEmail').value,
        phone: document.getElementById('settingsPhoneNumber').value
      };
      localStorage.setItem('currentUser', JSON.stringify(user));
      
      // Update dark mode
      const darkModeEnabled = document.getElementById('settingsDarkMode').checked;
      if (darkModeEnabled) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
        localStorage.setItem('darkMode', 'true');
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('darkModeIcon').textContent = 'üåô';
        localStorage.setItem('darkMode', 'false');
      }
      
      alert('Settings saved successfully!');
      closeAccountSettings();
    });

    // Export to PDF
    function exportPDF(period) {
      const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
      const accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      const today = new Date();
      let filteredTransactions = transactions;

      // Filter transactions by period
      if (period === 'day') {
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfDay);
      } else if (period === 'week') {
        const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
        filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfWeek);
      } else if (period === 'month') {
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfMonth);
      } else if (period === 'year') {
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        filteredTransactions = transactions.filter(t => new Date(t.date) >= startOfYear);
      }

      // Calculate totals
      let totalIncome = 0, totalExpense = 0;
      filteredTransactions.forEach(t => {
        if (t.type === 'credit') totalIncome += t.amount;
        else totalExpense += t.amount;
      });

      // Create HTML content
      const htmlContent = `
        <html>
          <head>
            <title>Expense Report - ${period}</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, Arial; margin: 20px; }
              h1 { color: #0066cc; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
              th { background-color: #0066cc; color: white; }
              .summary { background-color: #f5f7fa; padding: 15px; border-radius: 8px; margin: 20px 0; }
              .summary-item { display: inline-block; margin-right: 30px; }
            </style>
          </head>
          <body>
            <h1>Expense Report - ${period.charAt(0).toUpperCase() + period.slice(1)}</h1>
            <p>Generated on: ${new Date().toLocaleDateString()}</p>
            
            <div class="summary">
              <div class="summary-item"><strong>Total Income:</strong> ‚Çπ${totalIncome.toFixed(2)}</div>
              <div class="summary-item"><strong>Total Expense:</strong> ‚Çπ${totalExpense.toFixed(2)}</div>
              <div class="summary-item"><strong>Net:</strong> ‚Çπ${(totalIncome - totalExpense).toFixed(2)}</div>
            </div>

            <h2>Transactions</h2>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Account</th>
                  <th>Category</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Payment Method</th>
                </tr>
              </thead>
              <tbody>
                ${filteredTransactions.map(t => {
                  const account = accounts.find(a => a.id === t.accountId);
                  return `<tr>
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td>${account ? account.bankName : 'Unknown'}</td>
                    <td>${t.category}</td>
                    <td>${t.type}</td>
                    <td>‚Çπ${t.amount.toFixed(2)}</td>
                    <td>${t.paymentMethod || 'N/A'}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </body>
        </html>
      `;

      // Generate PDF
      const element = document.createElement('div');
      element.innerHTML = htmlContent;
      const opt = {
        margin: 10,
        filename: `expense-report-${period}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      html2pdf().set(opt).from(htmlContent).save();
    }

    // Settings button click
    document.getElementById('settingsBtn').addEventListener('click', openAccountSettings);

    // Close modal when clicking outside
    document.getElementById('accountSettingsModal').addEventListener('click', function(e) {
      if (e.target === this) closeAccountSettings();
    });
  </script>
</body>
</html>
